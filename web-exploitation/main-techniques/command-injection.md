---
icon: syringe
---

# Command Injection

{% hint style="info" %}
### <mark style="color:purple;">Recon</mark>

* <mark style="color:purple;">Always submit especial characters in the request -></mark> <mark style="color:orange;">**`!@$%^&`**</mark>
* <mark style="color:orange;">**`&`**</mark> <mark style="color:purple;">in Linux allows to run commands in the background.</mark>&#x20;

***

* <mark style="color:purple;">If you find a command injection, test whether the system can establish outbound connections to an external server:</mark>  &#x20;

```url
ping+10.10.10.10
```

* <mark style="color:purple;">And wait for  it with</mark> <mark style="color:orange;">**`tcpdump`**</mark><mark style="color:purple;">**:**</mark>

```sh
tcpdump -i tun0 icmp
```

* <mark style="color:purple;">In Linux IP addresses can be written in</mark> <mark style="color:orange;">**`decimal`**</mark> <mark style="color:purple;">and</mark> <mark style="color:orange;">**`HEX`**</mark><mark style="color:purple;">, this can be useful if</mark> <mark style="color:orange;">**`dots`**</mark> <mark style="color:purple;">are blacklisted.</mark>
{% endhint %}

***

***

{% hint style="info" %}
### <mark style="color:orange;">`PHP`</mark>

* <mark style="color:orange;">**`preg_replace()`**</mark> <mark style="color:purple;">function is used in PHP to perform regular expression-based replacements.</mark>
  * <mark style="color:purple;">Syntax:</mark> <mark style="color:orange;">**`preg_replace(pattern, replacement, subject);`**</mark>
  * <mark style="color:purple;">If the</mark> <mark style="color:orange;">**`/e`**</mark> <mark style="color:purple;">modifier (or</mark> <mark style="color:orange;">**`PREG_REPLACE_EVAL`**</mark><mark style="color:purple;">) is used, the replacement string can be executed as PHP code before the replacement occurs.</mark>
* <mark style="color:purple;">**Attack Technique**</mark><mark style="color:purple;">:</mark>
  * <mark style="color:purple;">While the</mark> <mark style="color:orange;">**`/e`**</mark> <mark style="color:purple;">modifier may not be explicitly present in the original code, it can be injected into the regular expression pattern through user input.</mark>
  * <mark style="color:purple;">If user input is used directly in the</mark> <mark style="color:orange;">**`preg_replace()`**</mark> <mark style="color:purple;">function, attackers can manipulate requests to inject the</mark> <mark style="color:orange;">**`/e`**</mark> <mark style="color:purple;">modifier into the pattern, causing arbitrary PHP code execution.</mark>
* <mark style="color:purple;">**Look for regex patterns on POST requests (**</mark><mark style="color:orange;">**`/`**</mark><mark style="color:purple;">**)**</mark>
* <mark style="color:purple;">Some payload examples:</mark>

{% code title="Intercepted POST request" %}
```
pattern=%2Fx%2Fe&ipaddress=system("id")&text=x
```
{% endcode %}

{% code title="Plain PHP" %}
```php
preg_replace(/x/e, system("id"), x)
```
{% endcode %}
{% endhint %}

